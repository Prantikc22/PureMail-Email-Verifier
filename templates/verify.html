{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4">Verify Email Addresses</h2>

    <!-- Upload Area -->
    <div class="upload-area bg-white p-5 rounded shadow-sm text-center mb-4">
        <form id="uploadForm" action="{{ url_for('verify') }}" method="post" enctype="multipart/form-data" class="mb-4">
            <div class="drag-drop-area p-5 mb-4 rounded border border-dashed" id="dropZone">
                <i class="bi bi-cloud-upload text-primary mb-3" style="font-size: 3rem;"></i>
                <h4>Drag & Drop Files Here</h4>
                <p class="text-muted">or</p>
                <label for="file" class="btn btn-primary">
                    Choose File
                    <input type="file" id="file" name="file" accept=".csv,.txt,.xlsx" style="display: none;" onchange="handleFileSelect(this)">
                </label>
                <p class="mt-2 text-muted small">Supported formats: CSV, TXT, Excel</p>
            </div>
            <div id="fileInfo" class="alert alert-info" style="display: none;">
                <span id="fileName"></span>
                <button type="button" class="btn-close" aria-label="Close" onclick="clearFile()"></button>
            </div>
            <button type="submit" class="btn btn-success btn-lg" id="submitBtn" style="display: none;">
                <i class="bi bi-check-circle me-2"></i>Start Verification
            </button>
        </form>
    </div>

    <!-- Feature Boxes -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="feature-card bg-white shadow-sm">
                <i class="bi bi-shield-check text-primary mb-3" style="font-size: 2rem;"></i>
                <h5>Advanced Validation</h5>
                <p class="text-muted">Multi-layer verification including syntax, domain, and mailbox validation</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card bg-white shadow-sm">
                <i class="bi bi-graph-up text-success mb-3" style="font-size: 2rem;"></i>
                <h5>AI-Powered Analysis</h5>
                <p class="text-muted">Smart scoring system to evaluate email quality and engagement potential</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card bg-white shadow-sm">
                <i class="bi bi-shield-x text-danger mb-3" style="font-size: 2rem;"></i>
                <h5>Disposable Detection</h5>
                <p class="text-muted">Identify and filter out temporary and disposable email addresses</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card bg-white shadow-sm">
                <i class="bi bi-lightning text-warning mb-3" style="font-size: 2rem;"></i>
                <h5>Real-time Processing</h5>
                <p class="text-muted">Fast and efficient verification with instant results</p>
            </div>
        </div>
    </div>

    <!-- Results Area -->
    <div id="resultsArea" style="display: none;">
        <div class="bg-white p-4 rounded shadow-sm">
            <h4 class="mb-4">Verification Results</h4>
            <div class="progress mb-4" style="height: 25px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="progressBar">
                    <span id="progressText">0%</span>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Details</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.drag-drop-area {
    border: 2px dashed #ccc;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.drag-drop-area.drag-over {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}

.feature-card {
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
    height: 100%;
    transition: transform 0.2s;
}

.feature-card:hover {
    transform: translateY(-5px);
}
</style>

<script>
    function handleFileSelect(input) {
        const file = input.files[0];
        if (file) {
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('submitBtn').style.display = 'block';
        }
    }

    function clearFile() {
        document.getElementById('file').value = '';
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'none';
    }

    // Drag and drop handling
    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file) {
            const input = document.getElementById('file');
            input.files = e.dataTransfer.files;
            handleFileSelect(input);
        }
    });

    // Form submission handling
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const submitBtn = document.getElementById('submitBtn');
        const resultsArea = document.getElementById('resultsArea');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const resultsTable = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];

        submitBtn.disabled = true;
        resultsArea.style.display = 'block';
        resultsTable.innerHTML = '';

        try {
            const response = await fetch("{{ url_for('verify') }}", {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const results = await response.json();
            let validCount = 0;

            results.forEach((result, index) => {
                if (result.valid) validCount++;
                
                const progress = Math.round(((index + 1) / results.length) * 100);
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${progress}%`;

                const row = resultsTable.insertRow();
                row.innerHTML = `
                    <td>${result.email}</td>
                    <td>
                        <span class="badge bg-${result.valid ? 'success' : 'danger'}">
                            ${result.valid ? 'Valid' : 'Invalid'}
                        </span>
                    </td>
                    <td>${result.reason || 'N/A'}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress" style="width: 100px; height: 10px;">
                                <div class="progress-bar bg-${getScoreColor(result.reply_score)}" 
                                     style="width: ${result.reply_score * 10}%">
                                </div>
                            </div>
                            <span class="ms-2">${result.reply_score}/10</span>
                        </div>
                    </td>
                `;
            });

            const validRatio = (validCount / results.length * 100).toFixed(1);
            progressBar.style.width = '100%';
            progressText.textContent = `Complete: ${validRatio}% Valid`;

        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred during verification. Please try again.');
        } finally {
            submitBtn.disabled = false;
        }
    });

    function getScoreColor(score) {
        if (score >= 8) return 'success';
        if (score >= 5) return 'warning';
        return 'danger';
    }
</script>
{% endblock %}
